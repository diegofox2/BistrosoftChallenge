sequenceDiagram
    participant Client
    participant Api as "OrdersController (BistrosoftChallenge.Api)"
    participant Publish as "IPublishEndpoint"
    participant Outbox as "EF Outbox (AppDbContext)"
    participant Db as "AppDbContext"
    participant BusOutbox as "Bus Outbox (same process)"
    participant Bus as "MassTransit Bus"
    participant Broker as "Broker (RabbitMQ / InMemory)"
    participant Worker as "CreateOrderStateMachine (Worker)"

    Client->>Api: POST /api/orders (CreateOrderRequest)
    Api->>Publish: Publish(CreateOrderCommand)
    Publish->>Outbox: Enqueue outbox entry (tied to DbContext)
    Api->>Db: SaveChangesAsync()&#59; persist outbox row

    alt UseBusOutbox configured
        Db->>BusOutbox: Commit triggers dispatch
        BusOutbox->>Bus: Dispatch message onto bus
    else DB-based external dispatcher
        Note over Db: Outbox row persisted&#59; external dispatcher will publish later
    end

    Bus->>Broker: Route message to exchange/queue
    Broker->>Worker: Deliver CreateOrderCommand
    Worker->>Worker: Consume CreateOrderCommand
    Worker->>Db: Load Customer and Products&#59; validate

    alt Validation fails
        Worker->>Broker: Publish(OrderCreationFailed)
        Worker->>Worker: Finalize saga with error
    else Validation succeeds
        Worker->>Db: Create Order and OrderItems&#59; update stock
        Worker->>Db: SaveChangesAsync()&#59; persist domain changes
        Worker->>Broker: Publish(OrderCreated)
        Worker->>Worker: Transition to Created and finalize
    end

    Worker->>Broker: Acknowledge (ACK)